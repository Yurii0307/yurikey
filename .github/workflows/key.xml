name: Update Keybox

on:
  workflow_dispatch:
    inputs:
      keybox_link:
        description: "Direct link to keybox file"
        required: true
        type: string
      options:
        description: "File type"
        required: true
        type: choice
        options:
          - zip
          - xml
      password:
        description: "Zip password (if needed)"
        required: false
        type: string

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install unzip
        run: sudo apt-get install -y unzip

      - name: Download file
        run: |
          curl -L "${{ inputs.keybox_link }}" -o input_file

      - name: Extract XML
        if: ${{ inputs.options == 'zip' }}
        run: |
          if [ -n "${{ inputs.password }}" ]; then
            unzip -P "${{ inputs.password }}" input_file
          else
            unzip input_file
          fi

      - name: Move file
        run: |
          if [ "${{ inputs.options }}" = "xml" ]; then
            mv input_file key
          else
            XML_FILE=$(find . -name "*.xml" | head -n 1)
            if [ -z "$XML_FILE" ]; then
              echo "No XML found!"
              exit 1
            fi
            mv "$XML_FILE" key
          fi

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add key
          git commit -m "Update keybox"
          git push
